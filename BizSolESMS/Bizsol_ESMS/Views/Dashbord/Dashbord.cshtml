@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    
    /* In your dashboard BG CSS */
    .main-content {
        background-image: url('../assets/images/Final_e-SMS-banner.png');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        min-height: 90vh;
        /* margin-left: 70px; */
    }

    @@media only screen and (width: 768px) and (max-width: 1366px) {
        .main-content {
            background-image: url('../assets/images/Final_e-SMS-banner.png');
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }
    }

    @@media (min-width: 320px) and (max-width: 480px) {
        .main-content {
            background-image: url('../assets/images/Final_ESMS.png');
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }
    }

</style>
<div alt="banner" class="banner">

    <!-- start page title -->
    <!-- end page title -->

    <div class="row">
        <div class="col-md-12">
            @* <img src="/assets/images/users/erpBanner.png" alt="banner" class="banner"/> *@
            @* <img src="~/assets/images/users/erp-banner1.png" alt="banner" class="banner"/> *@
        </div>
    </div>

    @*  <div class="row">
    <div class="col-xl-3 col-md-6">

    <div class="card card-h-100">

    <div class="card-body">
    <div class="row align-items-center">
    <div class="col-6">
    <span class="text-muted mb-3 lh-1 d-block text-truncate">My Wallet</span>
    <h4 class="mb-3">
    $<span class="counter-value" data-target="865.2">0</span>k
    </h4>
    </div>

    <div class="col-6">
    <div id="mini-chart1" data-colors='["#5156be"]' class="apex-charts mb-2"></div>
    </div>
    </div>
    <div class="text-nowrap">
    <span class="badge bg-success-subtle text-success">+$20.9k</span>
    <span class="ms-1 text-muted font-size-13">Since last week</span>
    </div>
    </div>
    </div>
    </div>
    </div> *@

    

</div>
<script>
    var authKeyData = null;
    try {
        var authKeyStr = sessionStorage.getItem('authKey');
        if (authKeyStr) {
            authKeyData = JSON.parse(authKeyStr);
        }
    } catch (e) {
        console.warn("Could not parse authKey from sessionStorage");
    }
    let UserMaster_Code = '@ViewBag.UserMaster_Code';

    $(document).ready(function () {
        // Get IP address first, then make API calls
        fetch('https://api.ipify.org')
            .then(response => response.text())
            .then(ip => {
                var ipAddress = ip.trim();
                
                // Update user IsActive status to 'Y' (logged in) with IP address
                // Try API endpoint first, fallback to LoginController if API fails
                $.ajax({
                    url: `@ViewBag.AppBaseURL/api/Master/UpdateIsActiveUser?UserMaster_Code=${UserMaster_Code}&IsActive=Y&IPAddress=${ipAddress}`,
                    type: 'GET',
                    beforeSend: function (xhr) {
                        if (authKeyData) {
                            xhr.setRequestHeader('Auth-Key', authKeyData);
                        }
                    },
                    success: function (response) {
                        console.log("User IsActive updated to Y via API");
                    },
                    error: function (xhr, status, error) {
                        // API endpoint not available - this is expected if API server is not running
                        // User status is already set during login, so this is optional
                        // Silent fail - not critical for dashboard functionality
                        if (xhr.status !== 0) { // Only log if it's a real HTTP error, not connection refused
                            console.warn("API endpoint not available, user status already set during login");
                        }
                    }
                });

                // Get user module rights and redirect to default page
                $.ajax({
                    url: `@ViewBag.AppBaseURL/api/UserMaster/GetUserModuleRightsList?CompanyCode=0&UserCode=${UserMaster_Code}`,
                    type: 'GET',
                    beforeSend: function (xhr) {
                        if (authKeyData) {
                            xhr.setRequestHeader('Auth-Key', authKeyData);
                        }
                    },
                    success: function (value) {
                        if (value && value.length > 0) {
                            let matchedItems = value.filter(item => item.Code == '@ViewBag.DefaultPage');
                            if (matchedItems.length > 0) {
                                location.href = "@ViewBag.AppBaseURLMenu/@ViewBag.FormToOpen";
                            }
                        } else {
                            console.warn("No data returned.");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error:", error);
                        toastr.error("Failed to fetch item data. Please try again.");
                    }
                });
            })
            .catch(error => {
                console.error("Error fetching IP address:", error);
                // Continue with API calls even if IP fetch fails
                var ipAddress = '';
                
                // Try API endpoint first, fallback to LoginController if API fails
                $.ajax({
                    url: `@ViewBag.AppBaseURL/api/Master/UpdateIsActiveUser?UserMaster_Code=${UserMaster_Code}&IsActive=Y&IPAddress=${ipAddress}`,
                    type: 'GET',
                    beforeSend: function (xhr) {
                        if (authKeyData) {
                            xhr.setRequestHeader('Auth-Key', authKeyData);
                        }
                    },
                    success: function (response) {
                        console.log("User IsActive updated to Y via API");
                    },
                    error: function (xhr, status, error) {
                        // API endpoint not available - this is expected if API server is not running
                        // User status is already set during login, so this is optional
                        // Silent fail - not critical for dashboard functionality
                        if (xhr.status !== 0) { // Only log if it's a real HTTP error, not connection refused
                            console.warn("API endpoint not available, user status already set during login");
                        }
                    }
                });

                $.ajax({
                    url: `@ViewBag.AppBaseURL/api/UserMaster/GetUserModuleRightsList?CompanyCode=0&UserCode=${UserMaster_Code}`,
                    type: 'GET',
                    beforeSend: function (xhr) {
                        if (authKeyData) {
                            xhr.setRequestHeader('Auth-Key', authKeyData);
                        }
                    },
                    success: function (value) {
                        if (value && value.length > 0) {
                            let matchedItems = value.filter(item => item.Code == '@ViewBag.DefaultPage');
                            if (matchedItems.length > 0) {
                                location.href = "@ViewBag.AppBaseURLMenu/@ViewBag.FormToOpen";
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error:", error);
                        toastr.error("Failed to fetch item data. Please try again.");
                    }
                });
            });
    });

</script>

